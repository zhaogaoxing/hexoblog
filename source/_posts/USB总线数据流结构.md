---
title: USB总线数据流结构
tag: USB开发
categories: USB开发
---
## USB总线数据流结构
USB总线的数据流是USB主机和USB设备数据通信的基础，一个完整的USB数据流包含3个阶段。
1.令牌阶段：其中定义了本次传输的类型，用于表征数据流的开始。由同步字段、令牌包和EOP构成，这是所有USB数据流必须包含的阶段。
2.数据阶段：其中包含了本次传输的数据，其数据大小根据端点的传输类型而定，最大的数据量为1024字节，由同步字段、数据包和EOP构成。
3.握手阶段：用于数据的接受方向发送方报告此次数据传输是否成功，由同步字段、握手包和EOP组成。

## USB数据流单元：字段
主要字段有：
同步字段（SYNC）：用于数据通信的同步
包标识字段（PID）：指明信息包类型，可以用于差错控制
地址字段（ADDR）：指明USB总线上的一个USB设备
端点字段（ENDP）：指明USB的端点
帧号字段（NUM）：指明当前帧的帧号
数据字段（DATA）：包含传输的数据
校验字段（CRC）：循环冗余校验

### 同步字段：SYNC
1.低速/全速同步字段，同步字段长度为8位，数据为10000000B，在数据总线上首先发送低位，然后再发送高位，USB总线数据采用NRZI编码，这样可以为发送方和接收方提供一个同步时钟。
2.高速同步字段，同步字段长度为32位，数据为80000000H，按照二进制发送，连续发送31个0，最后发送一个1。

### 包标识字段：PID
1.令牌包
2.握手包
3.数据包
4.特殊包

### 地址字段：ADDR
地址字段长度为7位，共有128个地址值。这里地址0作为默认地址，不能分配给USB设备。所以只有127个可以分配的地址值。   
USB上电时，USB主机首先通过默认地址0和USB设备进行通信，当USB上电配置完成后，USB主机便为该USB设备分配一个USB地址。

### 端点字段：ENDP
端点字段的长度为4位，一共可以表示16个端点，对于低速USB协议中只规定了3个端点，对于全速高速USB包含了全部16个端点。

### 帧号字段：NUM
字段长度为11位，最大值为07FFH。在每个帧或小帧发送时，帧号字段里的内容加1.

### 数据字段：DATA
数据字段最大长度为1024字段，首先传输低字段，再传输高字段。

### 校验字段：CRC
令牌包：一般采用5位循环冗余校验CRC
数据包：一般采用16位循环冗余校验CRC

## USB数据流构成：信息包

### 令牌包：USB传输类型
一共使用了8种临牌包：
1.IN、OUT、SETUP和PING令牌包。
2.SOF令牌包。
3.SPLIT令牌包
4.PRE令牌包